import java.io.*;
import java.sql.*;
import java.util.*;

public class InsertIntoStarSchema {
    public static void main(String[] args) {
        // Database credentials
        String dbUrl = "jdbc:mysql://localhost:3306/metro_dw";
        String dbUser = "root";
        String dbPassword = "12345";
        
        // Path to the enriched CSV file generated by the mesh join code
        String enrichedCsvFile = "C:\\Users\\Muhammad\\Desktop\\Datawarehouse_metro\\MySQLConnectionTest\\enriched_transactions.csv";

        try (Connection conn = DriverManager.getConnection(dbUrl, dbUser, dbPassword)) {
            System.out.println("Connected to MySQL database!");

            // Prepare statements for each table insert
            String insertProductSQL = "INSERT INTO product (product_id, product_name, price) VALUES (?, ?, ?)";
            String insertCustomerSQL = "INSERT INTO customer (customer_id, customer_name) VALUES (?, ?)";
            String insertStoreSQL = "INSERT INTO store (store_id, store_name) VALUES (?, ?)";
            String insertSupplierSQL = "INSERT INTO supplier (supplier_id, supplier_name) VALUES (?, ?)";
            String insertDateSQL = "INSERT INTO date (time_id, t_date, weekend, half_of_year, month, quarter, year) VALUES (?, ?, ?, ?, ?, ?, ?)";
            String insertSalesSQL = "INSERT INTO sales (transaction_id, product_id, customer_id, supplier_id, store_id, time_id, quantity, total_sale) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";

            // Prepared statements
            try (PreparedStatement productStmt = conn.prepareStatement(insertProductSQL);
                 PreparedStatement customerStmt = conn.prepareStatement(insertCustomerSQL);
                 PreparedStatement storeStmt = conn.prepareStatement(insertStoreSQL);
                 PreparedStatement supplierStmt = conn.prepareStatement(insertSupplierSQL);
                 PreparedStatement dateStmt = conn.prepareStatement(insertDateSQL);
                 PreparedStatement salesStmt = conn.prepareStatement(insertSalesSQL);
                 BufferedReader br = new BufferedReader(new FileReader(enrichedCsvFile))) {

                String line;
                br.readLine(); // Skip header line

                // Read each line from the enriched CSV file and insert data into the respective tables
                while ((line = br.readLine()) != null) {
                    String[] fields = line.split(",");
                    
                    // Extract data from the line
                    int transactionId = Integer.parseInt(fields[0]);
                    int productId = Integer.parseInt(fields[1]);
                    String productName = fields[2];
                    double productPrice = Double.parseDouble(fields[3]);
                    int customerId = Integer.parseInt(fields[4]);
                    String customerName = fields[5];
                    String customerGender = fields[6];
                    int storeId = Integer.parseInt(fields[7]);
                    String storeName = fields[8];
                    int supplierId = Integer.parseInt(fields[9]);
                    String supplierName = fields[10];
                    int timeId = Integer.parseInt(fields[11]);
                    String time = fields[12];
                    String date = fields[13];
                    boolean isWeekend = Boolean.parseBoolean(fields[14]);
                    String halfOfYear = fields[15];
                    int month = Integer.parseInt(fields[16]);
                    int quarter = Integer.parseInt(fields[17]);
                    int year = Integer.parseInt(fields[18]);
                    int quantity = Integer.parseInt(fields[19]);
                    double totalSales = Double.parseDouble(fields[20]);

                    // Insert data into product table
                    productStmt.setInt(1, productId);
                    productStmt.setString(2, productName);
                    productStmt.setDouble(3, productPrice);
                    productStmt.executeUpdate();

                    // Insert data into customer table
                    customerStmt.setInt(1, customerId);
                    customerStmt.setString(2, customerName);
                    customerStmt.executeUpdate();

                    // Insert data into store table
                    storeStmt.setInt(1, storeId);
                    storeStmt.setString(2, storeName);
                    storeStmt.executeUpdate();

                    // Insert data into supplier table
                    supplierStmt.setInt(1, supplierId);
                    supplierStmt.setString(2, supplierName);
                    supplierStmt.executeUpdate();

                    // Insert data into date table
                    dateStmt.setInt(1, timeId);
                    dateStmt.setString(2, date);
                    dateStmt.setBoolean(3, isWeekend);
                    dateStmt.setString(4, halfOfYear);
                    dateStmt.setInt(5, month);
                    dateStmt.setInt(6, quarter);
                    dateStmt.setInt(7, year);
                    dateStmt.executeUpdate();

                    // Insert data into sales (fact table)
                    salesStmt.setInt(1, transactionId);
                    salesStmt.setInt(2, productId);
                    salesStmt.setInt(3, customerId);
                    salesStmt.setInt(4, supplierId);
                    salesStmt.setInt(5, storeId);
                    salesStmt.setInt(6, timeId);
                    salesStmt.setInt(7, quantity);
                    salesStmt.setDouble(8, totalSales);
                    salesStmt.executeUpdate();
                }

                System.out.println("Data insertion completed!");

            } catch (IOException e) {
                System.out.println("Error reading CSV file.");
                e.printStackTrace();
            }

        } catch (SQLException e) {
            System.out.println("Error connecting to MySQL database.");
            e.printStackTrace();
        }
    }
}
